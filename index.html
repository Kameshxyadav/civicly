<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>civicLy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
      background: #fafafa;
      color: #1a1a1a;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ── Topbar ── */
    .topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 56px;
      background: #fff;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      padding: 0 1.25rem;
      z-index: 100;
    }

    .hamburger {
      width: 36px; height: 36px;
      background: none; border: none;
      cursor: pointer;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      gap: 4px; padding: 0;
    }

    .hamburger span {
      display: block; width: 18px; height: 2px;
      background: #1a1a1a; border-radius: 1px;
    }

    .brand {
      font-size: 1.125rem; font-weight: 600;
      color: #1a1a1a; margin-left: 0.75rem;
      letter-spacing: -0.02em; cursor: pointer;
    }

    /* ── Slide menu ── */
    .menu-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.15);
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 200;
    }
    .menu-overlay.open { opacity: 1; pointer-events: auto; }

    .menu {
      position: fixed; top: 0; left: 0;
      width: 280px; height: 100%;
      background: #fff;
      border-right: 1px solid #e5e5e5;
      transform: translateX(-100%);
      transition: transform 0.25s ease;
      z-index: 201; padding: 1.5rem;
    }
    .menu.open { transform: translateX(0); }

    .menu-header {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    .menu-brand {
      font-size: 1.25rem; font-weight: 600;
      letter-spacing: -0.02em;
    }

    .menu-close {
      width: 32px; height: 32px;
      background: none; border: none;
      font-size: 1.25rem; cursor: pointer;
      color: #737373; display: flex;
      align-items: center; justify-content: center;
      border-radius: 6px;
    }
    .menu-close:hover { background: #f5f5f5; }

    .menu nav { display: flex; flex-direction: column; gap: 2px; }

    .menu nav a {
      display: block; padding: 0.75rem 0.875rem;
      color: #525252; font-size: 0.9375rem;
      font-weight: 400; border-radius: 8px;
      cursor: pointer; transition: all 0.15s ease;
    }
    .menu nav a:hover { background: #f5f5f5; color: #1a1a1a; }
    .menu nav a.active { background: #f5f5f5; color: #1a1a1a; font-weight: 500; }

    /* ── Layout ── */
    main { flex: 1; padding-top: 56px; }
    .page { display: none; }
    .page.active { display: block; }

    .container {
      max-width: 880px;
      margin: 0 auto;
      padding: 3rem 1.5rem 4rem;
    }

    .page-title {
      font-size: 1.75rem; font-weight: 600;
      letter-spacing: -0.02em; margin-bottom: 0.375rem;
    }

    .page-desc {
      font-size: 0.9375rem; color: #737373;
      margin-bottom: 2.5rem;
    }

    /* ── Hero ── */
    .hero {
      display: flex; align-items: center;
      justify-content: center;
      padding: 5rem 1.5rem 3rem;
    }

    .hero-content { max-width: 600px; text-align: center; }

    .hero-content h1 {
      font-size: clamp(2.5rem, 6vw, 3.75rem);
      font-weight: 700; line-height: 1.08;
      letter-spacing: -0.035em; margin-bottom: 1.5rem;
    }

    .hero-desc {
      font-size: 1.0625rem; line-height: 1.7;
      color: #737373; margin-bottom: 0;
    }

    /* ── Card ── */
    .card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 1.75rem;
      margin-bottom: 1.25rem;
    }

    .card-label {
      font-size: 0.8125rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.04em;
      color: #a3a3a3; margin-bottom: 1rem;
    }

    /* ── Upload zone ── */
    .upload-zone {
      border: 2px dashed #e5e5e5;
      border-radius: 10px;
      padding: 2.5rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    .upload-zone:hover { border-color: #d4d4d4; background: #f5f5f5; }
    .upload-zone.has-file { border-style: solid; padding: 1rem; border-color: #e5e5e5; background: #fff; }
    .upload-label { font-size: 0.9375rem; color: #525252; font-weight: 500; margin-bottom: 0.25rem; }
    .upload-hint { font-size: 0.8125rem; color: #a3a3a3; }
    .upload-zone img {
      max-width: 100%; max-height: 280px;
      border-radius: 8px; display: block; margin: 0 auto;
    }

    /* ── Form ── */
    .field { margin-bottom: 1rem; }
    .field-label {
      display: block; font-size: 0.8125rem;
      font-weight: 500; color: #525252;
      margin-bottom: 0.375rem;
    }

    input, select {
      width: 100%; padding: 0.75rem 1rem;
      border-radius: 8px; border: 1px solid #e5e5e5;
      background: #fff; font-size: 0.9375rem;
      font-family: inherit; color: #1a1a1a;
      transition: border-color 0.15s ease;
    }

    select {
      appearance: none; -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2.5 4.5l3.5 3.5 3.5-3.5' fill='none' stroke='%23737373' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    input:focus, select:focus { outline: none; border-color: #a3a3a3; }
    input:disabled { background: #f5f5f5; color: #737373; cursor: default; }

    /* ── Buttons ── */
    .btn {
      display: inline-flex; align-items: center;
      justify-content: center;
      padding: 0.8125rem 1.5rem;
      border: none; border-radius: 8px;
      font-size: 0.9375rem; font-weight: 500;
      font-family: inherit; cursor: pointer;
      transition: all 0.15s ease; width: 100%;
    }
    .btn-dark { background: #1a1a1a; color: #fff; }
    .btn-dark:hover { background: #404040; }
    .btn-dark:disabled { background: #d4d4d4; cursor: default; }

    .btn-back {
      display: inline-flex; align-items: center; gap: 0.375rem;
      background: none; border: none; color: #737373;
      font-size: 0.875rem; font-weight: 500;
      font-family: inherit; cursor: pointer;
      padding: 0; margin-bottom: 2rem;
      transition: color 0.15s ease;
    }
    .btn-back:hover { color: #1a1a1a; }

    /* ── Results on Home ── */
    .results { display: none; }
    .results.show { display: block; }

    .result-link {
      display: flex; justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1rem;
      border-bottom: 1px solid #f5f5f5;
      font-size: 0.9375rem;
      cursor: pointer; border-radius: 6px;
      transition: background 0.15s ease;
    }
    .result-link:last-child { border-bottom: none; }
    .result-link:hover { background: #f9f9f9; }
    .result-key { color: #1a1a1a; font-weight: 500; }
    .result-val { color: #737373; }
    .result-arrow { color: #d4d4d4; font-size: 0.75rem; margin-left: 0.75rem; }

    .chart-wrap { max-width: 260px; margin: 1.5rem auto; }

    /* ── Home map ── */
    .home-map {
      height: 400px; border-radius: 10px;
      border: 1px solid #e5e5e5; overflow: hidden;
    }

    /* ── Detail page ── */
    .detail-image {
      width: 100%; max-height: 320px;
      object-fit: cover; border-radius: 10px;
      border: 1px solid #e5e5e5;
      margin-bottom: 1.5rem;
    }

    .detail-stat {
      display: flex; justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f5f5f5;
      font-size: 0.9375rem;
    }
    .detail-stat:last-child { border-bottom: none; }
    .detail-stat-key { color: #737373; }
    .detail-stat-val { font-weight: 500; }

    .facility-item {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .facility-item:last-child { border-bottom: none; }

    .facility-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #a3a3a3; flex-shrink: 0;
    }

    .facility-name { font-size: 0.9375rem; }

    .detail-map {
      height: 380px; border-radius: 10px;
      border: 1px solid #e5e5e5; overflow: hidden;
    }

    /* ── Buy grid ── */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1rem;
    }

    .listing {
      background: #fff; border: 1px solid #e5e5e5;
      border-radius: 12px; overflow: hidden;
      transition: border-color 0.15s ease;
    }
    .listing:hover { border-color: #d4d4d4; }

    .listing-thumb {
      height: 120px; display: flex;
      align-items: center; justify-content: center;
    }

    .listing-body { padding: 1.125rem; }

    .listing-tag {
      font-size: 0.6875rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: #a3a3a3; margin-bottom: 0.375rem;
    }

    .listing-info { font-size: 0.875rem; color: #525252; margin-bottom: 0.25rem; }
    .listing-price { font-size: 1.125rem; font-weight: 600; margin: 0.625rem 0; }
    .listing-meta { font-size: 0.75rem; color: #a3a3a3; margin-bottom: 0.875rem; }

    .listing-btn {
      width: 100%; padding: 0.5625rem;
      background: #fff; color: #1a1a1a;
      border: 1px solid #e5e5e5; border-radius: 6px;
      font-size: 0.8125rem; font-weight: 500;
      cursor: pointer; font-family: inherit;
      transition: all 0.15s ease;
    }
    .listing-btn:hover { background: #fafafa; border-color: #d4d4d4; }

    /* ── Toast ── */
    .toast {
      position: fixed; bottom: 1.5rem; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #1a1a1a; color: #fff;
      padding: 0.75rem 1.25rem; border-radius: 8px;
      font-size: 0.875rem; opacity: 0;
      transition: all 0.3s ease; z-index: 300;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* ── Footer ── */
    footer {
      text-align: center; padding: 1rem 1.5rem;
      font-size: 0.8125rem; color: #a3a3a3;
      background: #1a1a1a;
    }

    /* ── Responsive ── */
    @media (max-width: 640px) {
      .container { padding: 2rem 1.25rem 3rem; }
      .card { padding: 1.5rem; }
      .grid { grid-template-columns: 1fr; }
      .hero { padding: 3rem 1.25rem 2rem; }
      .chart-wrap { max-width: 200px; }
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <button class="hamburger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <span class="brand" onclick="navigate('home')">civicLy</span>
  </div>

  <!-- Menu -->
  <div class="menu-overlay" onclick="toggleMenu()"></div>
  <aside class="menu">
    <div class="menu-header">
      <span class="menu-brand">civicLy</span>
      <button class="menu-close" onclick="toggleMenu()">&times;</button>
    </div>
    <nav>
      <a data-page="home" class="active" onclick="navigate('home')">Home</a>
      <a data-page="sell" onclick="navigate('sell')">Sell</a>
      <a data-page="buy" onclick="navigate('buy')">Buy</a>
    </nav>
  </aside>

  <main>

    <!-- ────── HOME ────── -->
    <section id="home" class="page active">

      <!-- Hero -->
      <div class="hero">
        <div class="hero-content">
          <h1>From waste<br>to value.</h1>
          <p class="hero-desc">
            AI-powered identification, smart routing to the nearest
            facility, and a marketplace to buy and sell recyclable
            materials — building a circular economy, one scan at a time.
          </p>
        </div>
      </div>

      <!-- Analyze (on Home) -->
      <div class="container" style="padding-top:0">
        <div class="card">
          <div class="card-label">Analyze</div>
          <div class="upload-zone" id="azUpload" onclick="document.getElementById('azFile').click()">
            <input type="file" id="azFile" accept="image/*" hidden
              onchange="previewImg(this,'azPreview','azPh','azUpload','azBtn')">
            <div id="azPh">
              <p class="upload-label">Click to upload an image</p>
              <span class="upload-hint">JPG, PNG up to 10MB</span>
            </div>
            <img id="azPreview" style="display:none" alt="Preview">
          </div>
          <div style="margin-top:1.25rem">
            <button class="btn btn-dark" id="azBtn" disabled onclick="analyzeWaste()">
              Analyze Image
            </button>
          </div>
        </div>

        <!-- Results after analysis -->
        <div class="results" id="azResults">
          <div class="card">
            <div class="card-label">Detection</div>
            <div id="azRows"></div>
          </div>
          <div class="card">
            <div class="card-label">Composition</div>
            <div class="chart-wrap"><canvas id="azChart"></canvas></div>
          </div>
          <div class="card">
            <div class="card-label">Nearest Facilities</div>
            <p style="font-size:0.8125rem;color:#a3a3a3;margin-bottom:1rem">
              Based on detected types and your current location.
            </p>
            <div id="homeMap" class="home-map"></div>
          </div>
        </div>
      </div>

    </section>

    <!-- ────── DETAIL (per waste type) ────── -->
    <section id="detail" class="page">
      <div class="container">
        <button class="btn-back" onclick="navigate('home')">&#8592; Back</button>

        <h1 class="page-title" id="dtTitle"></h1>
        <p class="page-desc" id="dtDesc"></p>

        <img class="detail-image" id="dtImage" alt="Analyzed waste">

        <div class="card">
          <div class="card-label">Analysis</div>
          <div id="dtStats"></div>
        </div>

        <div class="card">
          <div class="card-label">Facilities</div>
          <div id="dtFacilities"></div>
        </div>

        <div class="card">
          <div class="card-label">Route Map</div>
          <p style="font-size:0.8125rem;color:#a3a3a3;margin-bottom:1rem">
            Nearest facilities for this material based on your location.
          </p>
          <div class="detail-map" id="dtMap"></div>
        </div>
      </div>
    </section>

    <!-- ────── SELL ────── -->
    <section id="sell" class="page">
      <div class="container">
        <h1 class="page-title">Sell Material</h1>
        <p class="page-desc">List recyclable material for buyers near you.</p>

        <div class="card">
          <div class="field">
            <label class="field-label">Photo</label>
            <div class="upload-zone" id="slUpload" onclick="document.getElementById('slFile').click()">
              <input type="file" id="slFile" accept="image/*" hidden
                onchange="previewImg(this,'slPreview','slPh','slUpload')">
              <div id="slPh">
                <p class="upload-label">Click to upload an image</p>
                <span class="upload-hint">JPG, PNG up to 10MB</span>
              </div>
              <img id="slPreview" style="display:none" alt="Preview">
            </div>
          </div>
          <div class="field">
            <label class="field-label">Material</label>
            <select id="slType">
              <option value="" disabled selected>Select material</option>
              <option>Cardboard</option>
              <option>E-waste</option>
              <option>Glass</option>
              <option>Medical</option>
              <option>Metal</option>
              <option>Organic</option>
              <option>Paper</option>
              <option>Plastic</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Weight (kg)</label>
            <input type="number" id="slWeight" placeholder="e.g. 15">
          </div>
          <div class="field">
            <label class="field-label">Price</label>
            <input type="number" id="slPrice" placeholder="e.g. 500">
          </div>
          <div class="field">
            <label class="field-label">Contact</label>
            <input type="tel" id="slContact" placeholder="e.g. 9876543210">
          </div>
          <div class="field">
            <label class="field-label">Location</label>
            <input type="text" id="slLocation" disabled value="Detected on submit">
          </div>
          <div style="margin-top:0.5rem">
            <button class="btn btn-dark" onclick="createListing()">Create Listing</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ────── BUY ────── -->
    <section id="buy" class="page">
      <div class="container">
        <h1 class="page-title">Marketplace</h1>
        <p class="page-desc">Browse recyclable materials from sellers near you.</p>
        <div class="grid" id="buyGrid"></div>
      </div>
    </section>

  </main>

  <div class="toast" id="toast"></div>
  <footer>civicLy — Designed for circular economy</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let lat, lng, chart, homeMap, detailMap;
    let lastImageSrc = null;

    /* ── Navigation ── */
    function toggleMenu() {
      document.querySelector('.menu').classList.toggle('open');
      document.querySelector('.menu-overlay').classList.toggle('open');
    }

    function navigate(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      document.querySelectorAll('.menu nav a').forEach(a =>
        a.classList.toggle('active', a.dataset.page === page)
      );
      document.querySelector('.menu').classList.remove('open');
      document.querySelector('.menu-overlay').classList.remove('open');
      window.scrollTo(0, 0);
      if (page === 'sell') fetchLocation();
    }

    /* ── Location ── */
    function fetchLocation() {
      return new Promise((resolve, reject) => {
        if (lat && lng) { updateLoc(); resolve(); return; }
        navigator.geolocation.getCurrentPosition(pos => {
          lat = pos.coords.latitude;
          lng = pos.coords.longitude;
          updateLoc();
          resolve();
        }, () => {
          document.getElementById('slLocation').value = 'Could not detect';
          reject();
        });
      });
    }

    function updateLoc() {
      document.getElementById('slLocation').value = lat.toFixed(4) + ', ' + lng.toFixed(4);
    }

    /* ── Image preview (shared) ── */
    function previewImg(input, prevId, phId, zoneId, btnId) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById(prevId).src = e.target.result;
        document.getElementById(prevId).style.display = 'block';
        document.getElementById(phId).style.display = 'none';
        document.getElementById(zoneId).classList.add('has-file');
        if (btnId) document.getElementById(btnId).disabled = false;
        if (zoneId === 'azUpload') lastImageSrc = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    /* ── Analyze ── */
    function analyzeWaste() {
      const btn = document.getElementById('azBtn');
      btn.textContent = 'Analyzing...';
      btn.disabled = true;

      fetchLocation().then(() => {
        setTimeout(() => {
          const detected = [
            { type: 'Plastic', pct: 52 },
            { type: 'Metal',   pct: 31 },
            { type: 'Paper',   pct: 17 }
          ];

          // Clickable result rows
          document.getElementById('azRows').innerHTML = detected.map(d =>
            '<div class="result-link" onclick="openDetail(\'' + d.type + '\',' + d.pct + ')">' +
              '<span class="result-key">' + d.type + '</span>' +
              '<span><span class="result-val">' + d.pct + '%</span>' +
              '<span class="result-arrow">&#8594;</span></span>' +
            '</div>'
          ).join('');

          drawChart(detected);
          drawHomeMap(detected);

          document.getElementById('azResults').classList.add('show');
          btn.textContent = 'Analyze Image';
          btn.disabled = false;

          document.getElementById('azResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 1200);
      }).catch(() => {
        btn.textContent = 'Analyze Image';
        btn.disabled = false;
        toast('Location access is required for routing.');
      });
    }

    /* ── Chart ── */
    const typeColors = {
      Plastic: '#94a3b8', Metal: '#78909c', Paper: '#bcaaa4',
      'E-waste': '#b39ddb', Glass: '#80cbc4', Medical: '#ef9a9a',
      Organic: '#a5d6a7', Cardboard: '#d4a574'
    };

    function drawChart(data) {
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('azChart'), {
        type: 'doughnut',
        data: {
          labels: data.map(d => d.type),
          datasets: [{
            data: data.map(d => d.pct),
            backgroundColor: data.map(d => typeColors[d.type] || '#e5e5e5'),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          cutout: '58%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 14, usePointStyle: true,
                pointStyleWidth: 8, font: { size: 12 }
              }
            }
          }
        }
      });
    }

    /* ── Facilities data ── */
    const facilities = {
      Plastic:   [{ n: 'Plastic Recycling Center', a: -0.009, b: 0.007 }],
      Metal:     [{ n: 'Metal Factory', a: 0.012, b: 0.005 },
                  { n: 'Scrap Metal Yard', a: 0.01, b: -0.008 },
                  { n: 'Metal Recycling Plant', a: -0.01, b: 0.01 }],
      Paper:     [{ n: 'Paper Recycling Mill', a: 0.007, b: 0.009 }],
      'E-waste': [{ n: 'Authorized E-Waste Collection Center', a: -0.01, b: 0.008 }],
      Glass:     [{ n: 'Glass Recycling Plant', a: 0.008, b: -0.01 }],
      Medical:   [{ n: 'Medical Waste Disposal Facility', a: -0.008, b: -0.01 }],
      Organic:   [{ n: 'Composting Unit', a: 0.006, b: -0.007 },
                  { n: 'Bio-Waste Facility', a: -0.005, b: -0.009 }],
      Cardboard: [{ n: 'Cardboard Recycling Unit', a: 0.01, b: 0.01 }]
    };

    /* ── Home page map ── */
    function drawHomeMap(detected) {
      if (homeMap) {
        homeMap.eachLayer(l => { if (l instanceof L.Marker) homeMap.removeLayer(l); });
        homeMap.setView([lat, lng], 13);
      } else {
        homeMap = L.map('homeMap').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(homeMap);
      }

      // User location
      L.marker([lat, lng]).addTo(homeMap)
        .bindPopup('<strong>Your Location</strong>').openPopup();

      // Facility pins per detected type
      detected.forEach(d => {
        (facilities[d.type] || []).forEach(f => {
          L.marker([lat + f.a, lng + f.b]).addTo(homeMap)
            .bindPopup(
              '<strong>' + f.n + '</strong><br>' +
              '<span style="color:#737373;font-size:0.8125rem">' + d.type + ' — ' + d.pct + '%</span>'
            );
        });
      });

      setTimeout(() => homeMap.invalidateSize(), 200);
    }

    /* ── Detail page ── */
    function openDetail(type, pct) {
      const slug = type.toLowerCase().replace(/[^a-z]/g, '');
      window.location.hash = '/' + slug;

      document.getElementById('dtTitle').textContent = type;
      document.getElementById('dtDesc').textContent =
        'Routing and facility details for ' + type.toLowerCase() + ' waste.';
      document.getElementById('dtImage').src = lastImageSrc || '';

      document.getElementById('dtStats').innerHTML =
        '<div class="detail-stat"><span class="detail-stat-key">Material</span>' +
        '<span class="detail-stat-val">' + type + '</span></div>' +
        '<div class="detail-stat"><span class="detail-stat-key">Confidence</span>' +
        '<span class="detail-stat-val">' + (pct || '—') + '%</span></div>';

      const facs = facilities[type] || [];
      document.getElementById('dtFacilities').innerHTML = facs.map(f =>
        '<div class="facility-item">' +
          '<span class="facility-dot"></span>' +
          '<span class="facility-name">' + f.n + '</span>' +
        '</div>'
      ).join('') || '<p style="color:#a3a3a3;font-size:0.875rem">No facilities listed.</p>';

      navigate('detail');

      fetchLocation().then(() => {
        setTimeout(() => {
          if (detailMap) { detailMap.remove(); detailMap = null; }
          detailMap = L.map('dtMap').setView([lat, lng], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
          }).addTo(detailMap);

          L.marker([lat, lng]).addTo(detailMap).bindPopup('<strong>Your Location</strong>');

          facs.forEach(f => {
            L.marker([lat + f.a, lng + f.b]).addTo(detailMap)
              .bindPopup('<strong>' + f.n + '</strong>');
          });

          detailMap.invalidateSize();
        }, 150);
      });
    }

    /* ── Sell ── */
    function createListing() {
      const hasFile = document.getElementById('slFile').files.length > 0;
      const type    = document.getElementById('slType').value;
      const weight  = document.getElementById('slWeight').value;
      const price   = document.getElementById('slPrice').value;
      const contact = document.getElementById('slContact').value;

      if (!hasFile || !type || !weight || !price || !contact) {
        toast('Please fill in all fields including photo.');
        return;
      }

      fetchLocation().then(() => {
        toast('Listing created successfully.');
        document.getElementById('slFile').value = '';
        document.getElementById('slPreview').style.display = 'none';
        document.getElementById('slPh').style.display = '';
        document.getElementById('slUpload').classList.remove('has-file');
        document.getElementById('slType').selectedIndex = 0;
        document.getElementById('slWeight').value = '';
        document.getElementById('slPrice').value = '';
        document.getElementById('slContact').value = '';
      });
    }

    /* ── Buy ── */
    const buyListings = [
      { type: 'Plastic',   desc: 'PET bottles, cleaned',       wt: 15, price: 450,  km: 1.2, bg: '#edf2f7' },
      { type: 'Metal',     desc: 'Mixed scrap iron',           wt: 30, price: 2100, km: 3.5, bg: '#e2e8f0' },
      { type: 'Cardboard', desc: 'Shipping boxes, flattened',  wt: 8,  price: 160,  km: 0.8, bg: '#faecd5' },
      { type: 'E-waste',   desc: 'Old circuit boards',         wt: 5,  price: 1500, km: 4.2, bg: '#ede9fe' },
      { type: 'Glass',     desc: 'Assorted glass bottles',     wt: 12, price: 240,  km: 2.1, bg: '#d5f5e3' },
      { type: 'Paper',     desc: 'Office paper, mixed',        wt: 20, price: 300,  km: 1.7, bg: '#fef9e7' }
    ];

    (function renderBuyListings() {
      document.getElementById('buyGrid').innerHTML = buyListings.map(l =>
        '<div class="listing">' +
          '<div class="listing-thumb" style="background:' + l.bg + '"></div>' +
          '<div class="listing-body">' +
            '<div class="listing-tag">' + l.type + '</div>' +
            '<div class="listing-info">' + l.desc + '</div>' +
            '<div class="listing-info">' + l.wt + ' kg</div>' +
            '<div class="listing-price">' + l.price.toLocaleString('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }) + '</div>' +
            '<div class="listing-meta">' + l.km + ' km away</div>' +
            '<button class="listing-btn" onclick="toast(\'Contact details sent.\')">Contact Seller</button>' +
          '</div>' +
        '</div>'
      ).join('');
    })();

    /* ── Toast ── */
    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
